<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>åŒèˆˆç‡Ÿé€ -å¥½é‹åˆ®åˆ®æ¨‚</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            font-family: "Microsoft JhengHei", sans-serif;
            height: 100vh;
        }
        h2 { margin-top: 30px; color: #333; }
        .desc { color: #666; font-size: 14px; margin-bottom: 20px; }
        
        /* åˆ®åˆ®å¡å¤–æ¡† */
        .scratch-container {
            position: relative;
            width: 300px;
            height: 150px;
            border: 4px solid #333;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            overflow: hidden;
            background: white;
        }

        /* çé …å±¤ (åœ¨åº•éƒ¨) */
        .prize-layer {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0; z-index: 1;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; font-weight: bold; color: #e74c3c;
            text-align: center;
        }

        /* éŠ€æ¼†å±¤ (Canvas) */
        canvas {
            position: absolute; top: 0; left: 0; z-index: 2;
            cursor: pointer;
        }

        /* æŒ‰éˆ•å€ */
        .btn-area { margin-top: 30px; text-align: center; }
        button {
            padding: 12px 40px; font-size: 18px; border: none; border-radius: 50px;
            cursor: pointer; display: none; /* é è¨­éš±è— */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #claimBtn { background-color: #06c755; color: white; }
        #loading { display: block; background: none; color: #999; box-shadow: none; cursor: default;}
    </style>
</head>
<body>

    <h2>ğŸ‰ åŒèˆˆç‡Ÿé€  å°¾ç‰™æ¨‚ ğŸ‰</h2>
    <p class="desc">è«‹ç›´æ¥åœ¨ä¸‹æ–¹åˆ®é–‹éŠ€æ¼†</p>
    
    <div class="scratch-container">
        <div class="prize-layer" id="prizeText">æº–å‚™ä¸­...</div>
        <canvas id="scratchCanvas"></canvas>
    </div>

    <div class="btn-area">
        <button id="loading">è®€å–ä¸­...</button>
        <button id="claimBtn" onclick="closeLiff()">æˆ‘è¦é ˜ç</button>
    </div>

    <script>
        // â–¼â–¼â–¼ è¨­å®šå€ï¼šä¹‹å¾Œæ‹¿åˆ° LIFF ID è«‹å¡«åœ¨é€™è£¡ â–¼â–¼â–¼
        const MY_LIFF_ID = "è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„LIFF_ID"; 
        // â–²â–²â–² è¨­å®šå€çµæŸ â–²â–²â–²

        const canvas = document.getElementById('scratchCanvas');
        const ctx = canvas.getContext('2d');
        const width = 300;
        const height = 150;
        let isDrawing = false;

        // è¨­å®šç•«å¸ƒ
        canvas.width = width;
        canvas.height = height;
        
        // ç•«ä¸ŠéŠ€æ¼†
        ctx.fillStyle = '#CCCCCC';
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#666666';
        ctx.font = '24px Arial';
        ctx.fillText("è«‹åˆ®é–‹", 115, 85);
        
        // è¨­å®šæ“¦é™¤æ¨¡å¼
        ctx.globalCompositeOperation = 'destination-out';

        // ç›£è½ç•«å¸ƒæ“ä½œ
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            let cx = e.clientX || e.touches[0].clientX;
            let cy = e.clientY || e.touches[0].clientY;
            return { x: cx - rect.left, y: cy - rect.top };
        }
        function scratch(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
            ctx.fill();
            checkScratchPercent();
        }

        canvas.addEventListener('mousedown', () => isDrawing = true);
        canvas.addEventListener('touchstart', () => isDrawing = true);
        canvas.addEventListener('mousemove', scratch);
        canvas.addEventListener('touchmove', scratch);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('touchend', () => isDrawing = false);

        // æª¢æŸ¥åˆ®é–‹æ¯”ä¾‹
        let isRevealed = false;
        function checkScratchPercent() {
            if(isRevealed) return;
            const imageData = ctx.getImageData(0, 0, width, height);
            let clearCount = 0;
            for (let i = 3; i < imageData.data.length; i += 4) {
                if (imageData.data[i] === 0) clearCount++;
            }
            if ((clearCount / (width * height)) > 0.4) { // åˆ®é–‹ 40%
                isRevealed = true;
                document.getElementById('claimBtn').style.display = 'inline-block';
            }
        }

        // åˆå§‹åŒ– LIFF
        async function init() {
            try {
                // å¦‚æœé‚„æ²’å¡« IDï¼Œå…ˆä¸åˆå§‹åŒ–
                if(MY_LIFF_ID === "è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„LIFF_ID") {
                    document.getElementById('prizeText').innerText = "æœªè¨­å®š LIFF ID";
                    document.getElementById('loading').innerText = "è«‹è¨­å®šç¨‹å¼ç¢¼";
                    return;
                }

                await liff.init({ liffId: MY_LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // ç™»å…¥æˆåŠŸï¼Œæ±ºå®šçé … (é€™è£¡ç”¨ç°¡å–®éš¨æ©Ÿï¼Œæ‚¨å¯ä»¥æ”¹æˆå‘¼å« API)
                const prizes = ["ç¾é‡‘ 200å…ƒ", "ç¾é‡‘ 200å…ƒ", "é›»å½±ç¥¨ 1å¼µ", "ç‰¹ä¼‘ 1å¤©", "åƒåŠ ç é£²æ–™"];
                // éš¨æ©Ÿé¸ä¸€å€‹
                const result = prizes[Math.floor(Math.random() * prizes.length)];
                
                document.getElementById('prizeText').innerText = result;
                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                document.getElementById('prizeText').innerText = "éŒ¯èª¤";
                alert("LIFF åˆå§‹åŒ–å¤±æ•—: " + err);
            }
        }

        function closeLiff() {
            const prize = document.getElementById('prizeText').innerText;
            // å˜—è©¦ç™¼é€è¨Šæ¯å›èŠå¤©å®¤
            liff.sendMessages([{
                type: 'text',
                text: 'æˆ‘åƒåŠ äº†åŒèˆˆç‡Ÿé€ åˆ®åˆ®æ¨‚ï¼ŒæŠ½ä¸­äº†ï¼š' + prize
            }]).then(() => {
                liff.closeWindow();
            }).catch((err) => {
                // å¦‚æœç”¨æˆ¶æ²’æœ‰åŠ å…¥å¥½å‹ï¼Œå¯èƒ½æœƒç™¼é€å¤±æ•—ï¼Œç›´æ¥é—œé–‰
                liff.closeWindow();
            });
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>