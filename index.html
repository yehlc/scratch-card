<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>åŒèˆˆç‡Ÿé€ -å¥½é‹åˆ®åˆ®æ¨‚</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            font-family: "Microsoft JhengHei", sans-serif;
            height: 100vh;
        }
        h2 { margin-top: 30px; color: #333; }
        .desc { color: #666; font-size: 14px; margin-bottom: 20px; }
        
        .scratch-container {
            position: relative; width: 300px; height: 150px;
            border: 4px solid #333; border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            overflow: hidden; background: white;
            /* é è¨­é€æ˜åº¦é™ä½ï¼Œä»£è¡¨ä¸èƒ½åˆ® */
            opacity: 0.5; pointer-events: none; transition: opacity 0.5s;
        }

        .prize-layer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; font-weight: bold; color: #e74c3c; text-align: center; padding: 10px;
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 2; cursor: pointer; }

        .btn-area { margin-top: 30px; text-align: center; }
        button {
            padding: 12px 40px; font-size: 18px; border: none; border-radius: 50px;
            cursor: pointer; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #claimBtn { background-color: #06c755; color: white; }

        /* ç‹€æ…‹åˆ— */
        #status-bar {
            margin-top: 10px; padding: 8px 20px;
            background: #fff3cd; color: #856404; border-radius: 20px;
            font-size: 14px; display: block;
        }
    </style>
</head>
<body>

    <h2>ğŸ‰ åŒèˆˆç‡Ÿé€  å°¾ç‰™æ¨‚ ğŸ‰</h2>
    <div id="status-bar">æ­£åœ¨é€£ç·šè‡³ç¸½éƒ¨è³‡æ–™åº«...</div>
    
    <div class="scratch-container" id="cardArea">
        <div class="prize-layer" id="prizeText">...</div>
        <canvas id="scratchCanvas"></canvas>
    </div>

    <div class="btn-area">
        <button id="claimBtn" onclick="handleClaim()">æˆ‘è¦é ˜ç</button>
    </div>

    <script>
        // â–¼â–¼â–¼ è¨­å®šå€ â–¼â–¼â–¼
        const MY_LIFF_ID = "2009067472-oErqzHA9"; 
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzEpMd3sUtxOYoVbxYOgAANe5LCab4hcl3vTyoOWwOcBE7AItSWh0I7gdHjXN0I7oe_EA/exec"; 
        // â–²â–²â–² è¨­å®šå€çµæŸ â–²â–²â–²

        const canvas = document.getElementById('scratchCanvas');
        const ctx = canvas.getContext('2d');
        const width = 300; const height = 150;
        let isDrawing = false;
        let finalPrize = "";

        // ç•«å¸ƒåˆå§‹åŒ–
        canvas.width = width; canvas.height = height;
        ctx.fillStyle = '#CCCCCC'; ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#666666'; ctx.font = '24px Arial'; ctx.fillText("è®€å–ä¸­...", 110, 85);
        ctx.globalCompositeOperation = 'destination-out';

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            let cx = e.clientX || e.touches[0].clientX;
            let cy = e.clientY || e.touches[0].clientY;
            return { x: cx - rect.left, y: cy - rect.top };
        }
        function scratch(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            ctx.beginPath(); ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2); ctx.fill();
            checkScratchPercent();
        }
        canvas.addEventListener('mousedown', () => isDrawing = true);
        canvas.addEventListener('touchstart', () => isDrawing = true);
        canvas.addEventListener('mousemove', scratch);
        canvas.addEventListener('touchmove', scratch);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('touchend', () => isDrawing = false);

        let isRevealed = false;
        function checkScratchPercent() {
            if(isRevealed) return;
            const imageData = ctx.getImageData(0, 0, width, height);
            let clearCount = 0;
            for (let i = 3; i < imageData.data.length; i += 4) {
                if (imageData.data[i] === 0) clearCount++;
            }
            if ((clearCount / (width * height)) > 0.4) {
                isRevealed = true;
                document.getElementById('claimBtn').style.display = 'inline-block';
            }
        }

        async function init() {
            try {
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }

                const profile = await liff.getProfile();
                
                // å‘¼å« GAS é€²è¡ŒæŠ½ç
                fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ userId: profile.userId, displayName: profile.displayName })
                })
                .then(res => res.json())
                .then(data => {
                    const statusBar = document.getElementById('status-bar');
                    const cardArea = document.getElementById('cardArea');
                    
                    if (data.status === 'success' || data.status === 'played') {
                        // 1. æ‹¿åˆ°çå“ï¼Œæ›´æ–°åº•å±¤æ–‡å­—
                        finalPrize = data.prize;
                        document.getElementById('prizeText').innerText = finalPrize;
                        
                        // 2. æ›´æ–°éŠ€æ¼†å±¤æ–‡å­— (æŠŠ"è®€å–ä¸­"è“‹æ‰)
                        ctx.globalCompositeOperation = 'source-over'; // æ”¹å›æ­£å¸¸ç¹ªåœ–æ¨¡å¼
                        ctx.fillStyle = '#CCCCCC'; ctx.fillRect(0, 0, width, height); // é‡åˆ·åº•æ¼†
                        ctx.fillStyle = '#666666'; ctx.font = '24px Arial'; ctx.fillText("è«‹åˆ®é–‹", 115, 85);
                        ctx.globalCompositeOperation = 'destination-out'; // æ”¹å›æ“¦é™¤æ¨¡å¼

                        // 3. å•Ÿç”¨åˆ®åˆ®å¡
                        cardArea.style.opacity = '1';
                        cardArea.style.pointerEvents = 'auto';
                        
                        if (data.status === 'played') {
                            statusBar.innerText = "æ‚¨å·²ç¶“ç©éäº†ï¼Œé€™æ˜¯æ‚¨çš„çé …ç´€éŒ„";
                            statusBar.style.background = "#e2e3e5";
                            // ç›´æ¥åˆ®é–‹
                            ctx.clearRect(0, 0, width, height);
                            isRevealed = true;
                        } else {
                            statusBar.innerText = "æŠ½çè³‡æ ¼ç¢ºèªå®Œç•¢ï¼Œè«‹åˆ®é–‹ï¼";
                            statusBar.style.background = "#d4edda"; statusBar.style.color = "#155724";
                        }
                    } else if (data.status === 'empty') {
                        statusBar.innerText = "ä¾†æ™šäº†ä¸€æ­¥ï¼Œçå“å·²å…¨æ•¸ç™¼å®Œï¼";
                        cardArea.style.display = 'none';
                    } else {
                        statusBar.innerText = "ç³»çµ±éŒ¯èª¤ï¼š" + data.message;
                    }
                })
                .catch(err => {
                    document.getElementById('status-bar').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢";
                });

            } catch (err) {
                alert("LIFF Error: " + err);
            }
        }

        function handleClaim() {
            if (!liff.isInClient()) {
                alert('æ­å–œä¸­çï¼è«‹æˆªåœ–æ­¤ç•«é¢çµ¦å·¥ä½œäººå“¡ã€‚'); return;
            }
            liff.sendMessages([{
                type: 'text', text: 'ã€åŒèˆˆç‡Ÿé€ å°¾ç‰™ã€‘\n' + liff.getDecodedIDToken().name + '\næˆ‘åˆ®ä¸­äº†ï¼š' + finalPrize
            }]).then(() => { liff.closeWindow(); })
            .catch(() => { alert('æ­å–œä¸­çï¼š' + finalPrize + '\n(è¨Šæ¯ç™¼é€å¤±æ•—ï¼Œè«‹æˆªåœ–é ˜ç)'); });
        }

        init();
    </script>
</body>
</html>

